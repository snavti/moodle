{"version":3,"sources":["../src/move.js"],"names":["define","$","log","notification","ajax","SortableList","str","template","SELECTORS","DRAGGABLE","DRAGAREA","HANDLEELEMENT","MOVEDOWNCONTROL","MOVEUPCONTROL","origOrder","getSlotName","element","Deferred","resolve","attr","createHandles","promises","each","key","promise","get_string","innerText","then","string","render","movetitle","html","prepend","fail","exception","push","when","apply","startDrag","e","info","debug","sourceList","children","drop","newIndex","targetList","index","tutorial","target","closest","slot","get","moveslot","methodname","args","parseTutorialId","parseSlotId","calls","call","done","response","success","where","substr","id","init","remove","list","getElementName","on","EVENTS","DRAGSTART","DROP"],"mappings":"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","sourcesContent":["// This file is part of the tutorial booking activity plugin.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module that allows tutorial booking slots to\n * be moved by dragging and dropping them.\n *\n * @module     mod_tutorialbooking/move\n * @package    mod_tutorialbooking\n * @copyright  2019 University of Nottingham\n * @author     Neill Magill <neill.magill@nottingham.ac.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/notification', 'core/ajax', 'core/sortable_list', 'core/str', 'core/templates'],\n    function($, log, notification, ajax, SortableList, str, template) {\n    /**\n     * Stores CSS handles for various parts of Tutorial booking.\n     * @type Object\n     */\n    var SELECTORS = {\n        DRAGGABLE: '.tutorial_session',\n        DRAGAREA: '.tutorial_sessions',\n        HANDLEELEMENT: '.tutorial_session .sectionname',\n        MOVEDOWNCONTROL: '.tutorial_session .controls .movedown',\n        MOVEUPCONTROL: '.tutorial_session .controls .moveup'\n    };\n\n    /**\n     * Stores the original order of the slots.\n     * @type ElementList\n     */\n    var origOrder;\n\n    /**\n     * Sets up a tutorial booking page for drag and drop.\n     *\n     * @returns {undefined}\n     */\n    var init = function() {\n        log.debug('Setting up', 'mod_tutorialbooking/dragdrop');\n        // Remove the move controls.\n        $(SELECTORS.MOVEUPCONTROL).remove();\n        $(SELECTORS.MOVEDOWNCONTROL).remove();\n        createHandles();\n        var list = new SortableList(SELECTORS.DRAGAREA);\n        list.getElementName = getSlotName;\n        $(SELECTORS.DRAGAREA + ' ' + SELECTORS.DRAGGABLE).on(SortableList.EVENTS.DRAGSTART, startDrag)\n                .on(SortableList.EVENTS.DROP, drop);\n        log.debug('Setup completed', 'mod_tutorialbooking/dragdrop');\n    };\n\n    /**\n     * Gets the name of a slot.\n     *\n     * @param {Element} element\n     * @returns {Promise}\n     */\n    var getSlotName = function(element) {\n        return $.Deferred().resolve(element.attr('data-name'));\n    };\n\n    /**\n     * Generates the handle for the item.\n     *\n     * @returns {Promise}\n     */\n    var createHandles = function() {\n        var promises = [];\n        $(SELECTORS.HANDLEELEMENT).each(function(key, element) {\n            var promise = str.get_string('moveslot', 'mod_tutorialbooking', element.innerText).then(function(string) {\n                return template.render('core/drag_handle', {movetitle: string});\n            }).then(function(html) {\n                $(element).prepend($(html));\n                return;\n            }).fail(notification.exception);\n            promises.push(promise);\n        });\n        return $.when.apply($, promises);\n    };\n\n    /**\n     * Handles a drag start.\n     *\n     * @param {Event} e\n     * @param {Object} info Information passed by the SortableList events\n     * @returns {undefined}\n     */\n    var startDrag = function(e, info) {\n        log.debug('Drag started', 'mod_tutorialbooking/move');\n        // Remember position of the element in the beginning of dragging.\n        origOrder = info.sourceList.children();\n    };\n\n    /**\n     * Handles a drop event.\n     *\n     * Moves the slot to it's new position.\n     *\n     * @param {Event} e\n     * @param {Object} info Information passed by the SortableList events\n     * @returns {undefined}\n     */\n    var drop = function(e, info) {\n        log.debug('Dropped element', 'mod_tutorialbooking/move');\n        var newIndex = info.targetList.children().index(info.element);\n\n        // Find the element being dragged.\n        var tutorial = $(e.target).closest(SELECTORS.DRAGAREA);\n\n        // Make the AJAX call to move the slot.\n        var slot = info.element.attr('id');\n        var target = $(origOrder.get(newIndex)).attr('id');\n        var moveslot = {\n            methodname: 'mod_tutorialbooking_moveslot',\n            args: {\n                tutorial: parseTutorialId(tutorial),\n                slot: parseSlotId(slot),\n                target: parseSlotId(target)\n            }\n        };\n        var calls = ajax.call([moveslot]);\n        calls[0].done(function(response) {\n            if (response.success) {\n                // Move the slot.\n                if (response.where === 'before') {\n                    var message = 'Slot ' + slot + ' moved before slot ' + target;\n                    log.debug(message, 'mod_tutorialbooking/dragdrop');\n                } else {\n                    var message2 = 'Slot ' + slot + ' moved after slot ' + target;\n                    log.debug(message2, 'mod_tutorialbooking/dragdrop');\n                }\n            }\n        }).fail(notification.exception);\n    };\n\n    /**\n     * Gets the id of the tutorial based on it's css id.\n     *\n     * They will always have a css id in the form: tutorial-<number>\n     *\n     * @param {DOMElement} element\n     * @returns {Number}\n     */\n    var parseTutorialId = function(element) {\n        return $(element).attr('id').substr(9);\n    };\n\n    /**\n     * Gets the id of the slot based on it's css id.\n     *\n     * They will always have a css id in the form: slot-<number>\n     *\n     * @param {string} id\n     * @returns {Number}\n     */\n    var parseSlotId = function(id) {\n        return id.substr(5);\n    };\n\n    return {\n        init: init\n    };\n});\n"],"file":"move.min.js"}
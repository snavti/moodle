"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}define(["jquery","mod_jazzquiz/core"],function(e,t){var n=t.Quiz,s=t.Question,o=t.Ajax,r=t.setText,i=function(){function t(n){var s=this;_classCallCheck(this,t),this.quiz=n,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,e(document).on("click","#jazzquiz_undo_merge",function(){return s.undoMerge()}),e(document).on("click",function(e){e.target.classList.contains("bar")?s.startMerge(e.target.id):e.target.parentNode&&e.target.parentNode.classList.contains("bar")&&s.startMerge(e.target.parentNode.id)}),e(document).on("click","#review_show_normal_results",function(){return s.refresh(!1)}),e(document).on("click","#review_show_vote_results",function(){return s.refreshVotes()})}return _createClass(t,[{key:"clear",value:function(){n.responses.html(""),n.responseInfo.html("")}},{key:"hide",value:function(){n.uncheck(a.control("responses")),n.hide(n.responses),n.hide(n.responseInfo)}},{key:"show",value:function(){n.check(a.control("responses")),n.show(n.responses),n.show(n.responseInfo),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}},{key:"toggle",value:function(){this.showResponses=!this.showResponses,this.showResponses?this.show():this.hide()}},{key:"endMerge",value:function(){e(".merge-into").removeClass("merge-into"),e(".merge-from").removeClass("merge-from")}},{key:"undoMerge",value:function(){var e=this;o.post("undo_merge",{},function(){return e.refresh(!0)})}},{key:"merge",value:function(e,t){var n=this;o.post("merge_responses",{from:e,into:t},function(){return n.refresh(!1)})}},{key:"startMerge",value:function(t){var n=e("#"+t),s=n.parent();if(s.hasClass("merge-from"))this.endMerge();else{if(s.hasClass("merge-into")){var o=e(".merge-from");return this.merge(o.data("response"),s.data("response")),void this.endMerge()}s.addClass("merge-from"),s.parent().parent().find("tr").each(function(){e(this).find("td")[1].id!==n.attr("id")&&e(this).addClass("merge-into")})}}},{key:"createControls",value:function(t){if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){var s=e("#review_show_normal_results"),o=e("#review_show_vote_results");n.show(n.responseInfo),"vote_response"===t?0===s.length&&(r(n.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),n.responseInfo.append('<button id="review_show_normal_results" class="btn btn-primary"></button><br>'),r(e("#review_show_normal_results"),"click_to_show_original_results"),o.remove()):"current_response"===t&&0===o.length&&(r(n.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_original_results"),n.responseInfo.append('<button id="review_show_vote_results" class="btn btn-primary"></button><br>'),r(e("#review_show_vote_results"),"click_to_show_vote_results"),s.remove())}}else n.hide(n.responseInfo)}},{key:"createBarGraph",value:function(t,s,o,r,i){var a=document.getElementById(o);if(null!==a){for(var u=0,l=0,c=0;c<t.length;c++){var d=parseInt(t[c].count);u+=d,d>l&&(l=d)}0===u&&(u=1),i&&(a.innerHTML="");for(var h=0;h<a.rows.length;h++){for(var p=!0,f=0;f<t.length;f++)if(a.rows[h].dataset.response===t[f].response){p=!1;break}p&&(a.deleteRow(h),h--)}this.createControls(s),s+=r;for(var v=0;v<t.length;v++){for(var _=parseInt(t[v].count)/l*100,w=-1,m=-1,g=0;g<a.rows.length;g++)if(a.rows[g].dataset.response===t[v].response){w=a.rows[g].dataset.row_i,m=g;break}if(-1===w){w=a.rows.length;var z=a.insertRow();z.dataset.response_i=v,z.dataset.response=t[v].response,z.dataset.percent=_,z.dataset.row_i=w,z.dataset.count=t[v].count,z.classList.add("selected-vote-option"),_<15&&z.classList.add("outside");var q='<span id="'+s+"_count_"+w+'">'+t[v].count+"</span>",y=z.insertCell(0);y.onclick=function(){e(this).parent().toggleClass("selected-vote-option")};var k=z.insertCell(1);k.classList.add("bar"),k.id=s+"_bar_"+w,k.innerHTML='<div style="width:'+_+'%;">'+q+"</div>";var C=s+"_latex_"+w;y.innerHTML='<span id="'+C+'"></span>',n.addMathjaxElement(e("#"+C),t[v].response),"stack"===t[v].qtype&&n.renderMaximaEquation(t[v].response,C)}else{var b=a.rows[m];b.dataset.row_i=w,b.dataset.response_i=v,b.dataset.percent=_,b.dataset.count=t[v].count;var j=b.classList.contains("outside");_>15&&j?b.classList.remove("outside"):_<15&&!j&&b.classList.add("outside");var R=document.getElementById(s+"_count_"+w);null!==R&&(R.innerHTML=t[v].count);var Q=document.getElementById(s+"_bar_"+w);null!==Q&&(Q.firstElementChild.style.width=_+"%")}}}}},{key:"set",value:function(s,o,i,a,u,l,c){if(void 0!==i){if(0===i.length)return n.show(n.responded),void r(n.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(u){case"shortanswer":for(var d=0;d<i.length;d++)i[d].response=i[d].response.trim();break;case"stack":for(var h=0;h<i.length;h++)i[h].response=i[h].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(var p=0;p<i.length;p++){var f=!1,v=1;void 0!==i[p].count&&(v=parseInt(i[p].count)),this.respondedCount+=v;for(var _=0;_<this.currentResponses.length;_++)if(this.currentResponses[_].response===i[p].response){this.currentResponses[_].count+=v,f=!0;break}f||this.currentResponses.push({response:i[p].response,count:v,qtype:u})}if(0!==n.responded.length&&void 0!==a&&(n.show(n.responded),r(n.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:a,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return n.hide(n.responseInfo),void n.hide(n.responses);if(null===document.getElementById(o)){var w='<table id="'+o+'" class="jazzquiz-responses-overview"></table>';n.show(e("#"+s).html(w))}this.createBarGraph(this.currentResponses,"current_response",o,l,c),t.sortBarGraph(o)}}},{key:"refresh",value:function(t){var s=this;o.get("get_results",{},function(o){s.quiz.question.hasVotes=o.has_votes,s.totalStudents=parseInt(o.total_students),s.set("jazzquiz_responses_container","current_responses_wrapper",o.responses,o.responded,o.question_type,"results",t),o.merge_count>0?n.show(e("#jazzquiz_undo_merge")):n.hide(e("#jazzquiz_undo_merge"))})}},{key:"refreshVotes",value:function(){var e=this;if(!this.showResponses&&"reviewing"!==this.quiz.state)return n.hide(n.responseInfo),void n.hide(n.responses);o.get("get_vote_results",{},function(s){var o=s.answers,i="wrapper_vote_responses",a=[];for(var u in e.respondedCount=0,e.totalStudents=parseInt(s.total_students),o)o.hasOwnProperty(u)&&(a.push({response:o[u].attempt,count:o[u].finalcount,qtype:o[u].qtype,slot:o[u].slot}),e.respondedCount+=parseInt(o[u].finalcount));if(r(n.responded.find("h4"),"a_out_of_b_voted","jazzquiz",{a:e.respondedCount,b:e.totalStudents}),null===document.getElementById(i)){n.show(n.responses.html('<table id="wrapper_vote_responses" class="jazzquiz-responses-overview"></table>'))}e.createBarGraph(a,"vote_response",i,"vote",!1),t.sortBarGraph(i)})}}],[{key:"sortBarGraph",value:function(e){var t=document.getElementById(e);if(null!==t)for(var n=!0;n;){n=!1;for(var s=0;s<t.rows.length-1;s++){if(parseInt(t.rows[s].dataset.percent)<parseInt(t.rows[s+1].dataset.percent)){t.rows[s].parentNode.insertBefore(t.rows[s+1],t.rows[s]),n=!0;break}}}}}]),t}(),a=function(){function t(n){var s=this;_classCallCheck(this,t),this.quiz=n,this.responses=new i(n),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,this.allowVote=!1,e(document).on("keyup",function(e){27===e.keyCode&&t.closeFullscreenView()}),e(document).on("click",function(e){t.closeQuestionListMenu(e,"improvise"),t.closeQuestionListMenu(e,"jump")}),t.addEvents({repoll:function(){return s.repollQuestion()},vote:function(){return s.runVoting()},improvise:function(){return s.showQuestionListSetup("improvise")},jump:function(){return s.showQuestionListSetup("jump")},next:function(){return s.nextQuestion()},end:function(){return s.endQuestion()},fullscreen:function(){return t.showFullscreenView()},answer:function(){return s.showCorrectAnswer()},responses:function(){return s.responses.toggle()},exit:function(){return s.closeSession()},quit:function(){return s.closeSession()},startquiz:function(){return s.startQuiz()}}),t.addHotkeys({t:"responses",r:"repoll",a:"answer",e:"end",j:"jump",i:"improvise",v:"vote",n:"next",f:"fullscreen"})}return _createClass(t,[{key:"onNotRunning",value:function(e){this.responses.totalStudents=e.student_count,n.hide(t.side),r(n.info,"instructions_for_instructor"),t.enableControls([]),n.hide(t.controlButtons);var s=t.control("startquiz").next();1===e.student_count?r(s,"one_student_has_joined"):e.student_count>1?r(s,"x_students_have_joined","jazzquiz",e.student_count):r(s,"no_students_have_joined"),n.show(t.control("startquiz").parent())}},{key:"onPreparing",value:function(e){n.hide(t.side),r(n.info,"instructions_for_instructor");var s=["improvise","jump","fullscreen","quit"];e.slot<this.totalQuestions&&s.push("next"),t.enableControls(s)}},{key:"onRunning",value:function(e){(this.responses.showResponses||this.responses.hide(),n.show(t.side),t.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=e.questiontime,this.quiz.question.isRunning)?(e.questionTime>0&&e.delay<-e.questiontime&&this.endQuestion(),this.responses.refresh(!t.isMerging)):this.quiz.question.startCountdown(e.questiontime,e.delay)&&(this.quiz.question.isRunning=!0)}},{key:"onReviewing",value:function(e){n.show(t.side);var o=["answer","repoll","fullscreen","improvise","jump","quit"];this.allowVote&&o.push("vote"),e.slot<this.totalQuestions&&o.push("next"),t.enableControls(o),s.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}},{key:"onSessionClosed",value:function(e){n.hide(t.side),n.hide(t.correctAnswer),t.enableControls([]),this.responses.clear(),this.quiz.question.isRunning=!1}},{key:"onVoting",value:function(e){this.responses.showResponses||this.responses.hide(),n.show(t.side),t.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}},{key:"onStateChange",value:function(s){e("#region-main").find("ul.nav.nav-tabs").css("display","none"),e("#region-main-settings-menu").css("display","none"),e(".region_main_settings_menu_proxy").css("display","none"),n.show(t.controlButtons),n.hide(t.control("startquiz").parent())}},{key:"onQuestionRefreshed",value:function(e){this.allowVote=e.voteable}},{key:"onTimerEnding",value:function(){this.endQuestion()}},{key:"onTimerTick",value:function(e){r(s.timer,"x_seconds_left","jazzquiz",e)}},{key:"startQuiz",value:function(){n.hide(t.control("startquiz").parent()),o.post("start_quiz",{},function(){return e("#jazzquiz_controls").removeClass("btn-hide")})}},{key:"endQuestion",value:function(){var e=this;this.quiz.question.hideTimer(),o.post("end_question",{},function(){"voting"===e.quiz.state?e.responses.showVotesUponReview=!0:(e.quiz.question.isRunning=!1,t.enableControls([]))})}},{key:"showQuestionListSetup",value:function(s){var r=this,i=t.control(s);i.hasClass("active")||o.get("list_"+s+"_questions",{},function(t){var o=r,a=e("#jazzquiz_"+s+"_menu"),u=i.offset().left-i.parent().offset().left;a.html("").addClass("active").css("margin-left",u+"px"),i.addClass("active");var l=t.questions;for(var c in l)if(l.hasOwnProperty(c)){var d=e('<button class="btn"></button>');n.addMathjaxElement(d,l[c].name),d.data({time:l[c].time,"question-id":l[c].questionid,"jazzquiz-question-id":l[c].jazzquizquestionid}),d.data("test",1),d.on("click",function(){var t=e(this).data("question-id"),n=e(this).data("time"),s=e(this).data("jazzquiz-question-id");o.jumpQuestion(t,n,s),a.html("").removeClass("active"),i.removeClass("active")}),a.append(d)}})}},{key:"runVoting",value:function(){var e=t.getSelectedAnswersForVote(),n={questions:encodeURIComponent(JSON.stringify(e))};o.post("run_voting",n,function(){})}},{key:"startQuestion",value:function(e,t,s,r){var i=this;n.hide(n.info),this.responses.clear(),this.hideCorrectAnswer(),o.post("start_question",{method:e,questionid:t,questiontime:s,jazzquizquestionid:r},function(e){return i.quiz.question.startCountdown(e.questiontime,e.delay)})}},{key:"jumpQuestion",value:function(e,t,n){this.startQuestion("jump",e,t,n)}},{key:"repollQuestion",value:function(){this.startQuestion("repoll",0,0,0)}},{key:"nextQuestion",value:function(){this.startQuestion("next",0,0,0)}},{key:"closeSession",value:function(){n.hide(e("#jazzquiz_undo_merge")),n.hide(s.box),n.hide(t.controls),r(n.info,"closing_session"),o.post("close_session",{},function(){return window.location=location.href.split("&")[0]})}},{key:"hideCorrectAnswer",value:function(){this.isShowingCorrectAnswer&&(n.hide(t.correctAnswer),n.uncheck(t.control("answer")),this.isShowingCorrectAnswer=!1)}},{key:"showCorrectAnswer",value:function(){var e=this;this.hideCorrectAnswer(),o.get("get_right_response",{},function(s){n.show(t.correctAnswer.html(s.right_answer)),n.renderAllMathjax(),n.check(t.control("answer")),e.isShowingCorrectAnswer=!0})}}],[{key:"addHotkeys",value:function(n){var s=function(s){n.hasOwnProperty(s)&&(n[s]={action:n[s],repeat:!1},e(document).on("keydown",function(o){if(!n[s].repeat&&!o.ctrlKey&&String.fromCharCode(o.which).toLowerCase()===s){var r=e(":focus").prop("tagName");if(void 0===r||"input"!==(r=r.toLowerCase())&&"textarea"!==r){o.preventDefault(),n[s].repeat=!0;var i=t.control(n[s].action);i.length&&!i.prop("disabled")&&i.click()}}}),e(document).on("keyup",function(e){String.fromCharCode(e.which).toLowerCase()===s&&(n[s].repeat=!1)}))};for(var o in n)s(o)}},{key:"addEvents",value:function(n){var s=function(s){n.hasOwnProperty(s)&&e(document).on("click","#jazzquiz_control_"+s,function(){t.enableControls([]),n[s]()})};for(var o in n)s(o)}},{key:"control",value:function(t){return e("#jazzquiz_control_"+t)}},{key:"getSelectedAnswersForVote",value:function(){var t=[];return e(".selected-vote-option").each(function(e,n){t.push({text:n.dataset.response,count:n.dataset.count})}),t}},{key:"enableControls",value:function(e){t.controlButtons.children("button").each(function(t,n){var s=n.getAttribute("id").replace("jazzquiz_control_","");n.disabled=-1===e.indexOf(s)})}},{key:"showFullscreenView",value:function(){n.main.hasClass("jazzquiz-fullscreen")?t.closeFullscreenView():(document.documentElement.style.overflowY="hidden",n.main.addClass("jazzquiz-fullscreen"))}},{key:"closeFullscreenView",value:function(){document.documentElement.style.overflowY="auto",n.main.removeClass("jazzquiz-fullscreen")}},{key:"closeQuestionListMenu",value:function(n,s){var o="#jazzquiz_"+s+"_menu";e(n.target).closest(o).length||(e(o).html("").removeClass("active"),t.control(s).removeClass("active"))}},{key:"addReportEventHandlers",value:function(){e(document).on("click","#report_overview_controls button",function(){var t=e(this).data("action");"attendance"===t?(e("#report_overview_responded").fadeIn(),e("#report_overview_responses").fadeOut()):"responses"===t&&(e("#report_overview_responses").fadeIn(),e("#report_overview_responded").fadeOut())})}},{key:"controls",get:function(){return e("#jazzquiz_controls_box")}},{key:"controlButtons",get:function(){return t.controls.find(".quiz-control-buttons")}},{key:"side",get:function(){return e("#jazzquiz_side_container")}},{key:"correctAnswer",get:function(){return e("#jazzquiz_correct_answer_container")}},{key:"isMerging",get:function(){return 0!==e(".merge-from").length}}]),t}();return{initialize:function(e,t,s){var o=new n(a);o.role.totalQuestions=e,t?(a.addReportEventHandlers(),o.role.responses.showResponses=!0,s.forEach(function(e){var t="jazzquiz_wrapper_responses_"+e.num,n="responses_wrapper_table_"+e.num,s="report_"+e.num;o.role.responses.set(t,n,e.responses,void 0,e.type,s,!1)})):o.poll(500)}}});
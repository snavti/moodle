define(["jquery","core/str","core/ajax","core/modal_factory","core/templates","core/fragment","core/modal_events"],function(a,b,c,d,e,f,g){var h={EMPTY_CONTENT:["<br><p><br></p>","<p><br></p>","<br>",""],ROOT_COMMENT_VALUE:0,GET_ALL_VALUE:0,TEMPLATE_COMMENTS:"mod_studentquiz/comments",TEMPLATE_COMMENT:"mod_studentquiz/comment",ACTION_CREATE:"mod_studentquiz_create_comment",ACTION_CREATE_REPLY:"mod_studentquiz_create_reply",ACTION_GET_ALL:"mod_studentquiz_get_comments",ACTION_EXPAND:"mod_studentquiz_expand_comment",ACTION_DELETE:"mod_studentquiz_delete_comment",ACTION_LOAD_FRAGMENT_FORM:"mod_studentquiz_load_fragment_form",ACTION_EXPAND_ALL:"action_expand_all",ACTION_COLLAPSE_ALL:"action_collapse_all",ACTION_RENDER_COMMENT:"action_render_comment",ACTION_APPEND_COMMENT:"action_append_comment",ACTION_EDITOR_INIT:"action_editor_init",ACTION_INIT:"action_init",ACTION_UPDATE_COMMENT_COUNT:"action_update_comment_count",ACTION_CLEAR_FORM:"action_clear_form",ACTION_SHOW_ERROR:"action_show_error",FRAGMENT_FORM_CALLBACK:"commentform",HAS_COMMENT_CLASS:"has-comment",ATTO_CONTENT_TYPE:{HAS_CONTENT:"has-content",NO_CONTENT:"no-content"},SELECTOR:{CONTAINER:".studentquiz-comment-container",EXPAND_ALL:".studentquiz-comment-expand",COLLAPSE_ALL:".studentquiz-comment-collapse",SUBMIT_BUTTON:"#id_submitbutton",CONTAINER_REPLIES:".studentquiz-container-replies",COMMENT_REPLIES_CONTAINER:".studentquiz-comment-replies",COMMENT_COUNT:".studentquiz-comment-postcount",COMMENT_TEXT:".studentquiz-comment-text",COMMENT_REPLIES_TEXT:".studentquiz-comment-replies .studentquiz-comment-text",LOADING_ICON:".studentquiz-comment-loading",COMMENT_AREA_FORM:"div.comment-area-form",FORM_SELECTOR:".studentquiz-comment-postform > div.comment-area-form",NO_COMMENT:".no-comment",COLLAPSE_LINK:".studentquiz-comment-collapselink",EXPAND_LINK:".studentquiz-comment-expandlink",COMMENT_ITEM:".studentquiz-comment-item",COMMENT_REPLIES_CONTAINER_TO_ITEM:".studentquiz-comment-replies .studentquiz-comment-item",FRAGMENT_FORM:".studentquiz-comment-postfragmentform",BTN_DELETE:".studentquiz-comment-btndelete",BTN_REPLY:".studentquiz-comment-btnreply",BTN_DELETE_REPLY:".studentquiz-comment-btndeletereply",ATTO_EDITOR_WRAP:".editor_atto_wrap",TEXTAREA:'textarea[id^="id_editor_question_"]',COMMENT_COUNT_NUMBER:".studentquiz-comment-count-number",COMMENT_COUNT_TEXT:".studentquiz-comment-count-text",ATTO:{CONTENT_WRAP:".editor_atto_content_wrap",CONTENT:".editor_atto_content",TOOLBAR:".editor_atto_toolbar"},COMMENT_ID:"#comment_",SPAN_COMMENT_ID:"#c",TOTAL_REPLY:".studentquiz-comment-totalreply",COMMENT_FILTER:".studentquiz-comment-filter",COMMENT_FILTER_HIDE:".hide-comment-filter",COMMENT_ERROR:".studentquiz-comment-container .comment-error",BTN_REPORT:".studentquiz-comment-btnreport",COMMENT_FILTER_ITEM:".studentquiz-comment-filter-item",COMMENT_FILTER_NAME:".studentquiz-comment-filter-name",COMMENT_FILTER_TYPE:".studentquiz-comment-filter-type"},get:function(){return{elementSelector:null,btnExpandAll:null,btnCollapseAll:null,addComment:null,containerSelector:null,questionId:null,dialogue:null,loadingIcon:null,lastFocusElement:null,formSelector:null,contextId:null,userId:null,string:{},deleteDialog:null,deleteTarget:null,numberToShow:5,cmId:null,countServerData:[],lastCurrentCount:0,lastTotal:0,expand:!1,forceCommenting:!1,canViewDeleted:!1,hasComment:!1,referer:null,highlight:0,sortFeature:null,sortable:[],workingState:!1,isNoComment:!1,init:function(b){M.util.js_pending(h.ACTION_INIT);var c=this;c.elementSelector=a("#"+a.escapeSelector(b.id));var d=c.elementSelector;c.btnExpandAll=d.find(h.SELECTOR.EXPAND_ALL),c.btnCollapseAll=d.find(h.SELECTOR.COLLAPSE_ALL),c.addComment=d.find(h.SELECTOR.SUBMIT_BUTTON),c.containerSelector=d.find(h.SELECTOR.CONTAINER_REPLIES),c.loadingIcon=d.find(h.SELECTOR.LOADING_ICON),c.formSelector=d.find(h.SELECTOR.FORM_SELECTOR),c.questionId=parseInt(d.data("questionid")),c.contextId=parseInt(d.data("contextid")),c.userId=parseInt(d.data("userid")),c.numberToShow=parseInt(d.data("numbertoshow")),c.cmId=parseInt(d.data("cmid")),c.countServerData={count:b.count,total:b.total},c.expand=b.expand||!1,c.referer=d.data("referer"),c.sortFeature=b.sortfeature,c.sortable=d.data("sortable"),c.string=d.data("strings"),c.forceCommenting=b.forcecommenting,c.canViewDeleted=b.canviewdeleted,c.isNoComment=b.isnocomment,c.initServerRender(),c.initBindEditor(),c.bindEvents(),M.util.js_complete(h.ACTION_INIT)},initServerRender:function(){var b=this;b.changeWorkingState(!0),a(h.SELECTOR.COMMENT_ITEM).each(function(){var c=a(this).data("id"),d=a(this).find(h.SELECTOR.SPAN_COMMENT_ID+c),e=[];b.expand&&(e=d.data("replies")||[]);var f={id:a(this).data("id"),deleted:d.data("deleted"),numberofreply:d.data("numberofreply"),expanded:b.expand,replies:e,root:!0};b.bindCommentEvent(f)});var c=b.expand?b.countServerData.total:b.countServerData.count.commentcount;b.updateCommentCount(c,b.countServerData.total),b.expand?(b.btnExpandAll.hide(),b.btnCollapseAll.show()):(b.btnExpandAll.show(),b.btnCollapseAll.hide());var d=window.location.search.substring(1),e=b.parseQueryString(d);if(b.highlight=parseInt(e.highlight)||0,0!==b.highlight){var f=a(h.SELECTOR.COMMENT_ID+b.highlight);f.length&&b.scrollToElement(f)}b.changeWorkingState(!1)},initBindEditor:function(){var a=this;M.util.js_pending(h.ACTION_EDITOR_INIT);var b=setInterval(function(){0!==a.formSelector.find(h.SELECTOR.ATTO.CONTENT).length&&(a.bindEditorEvent(a.formSelector),clearInterval(b),M.util.js_complete(h.ACTION_EDITOR_INIT))},500)},bindEvents:function(){var b=this;b.btnExpandAll.click(function(a){a.preventDefault(),M.util.js_pending(h.ACTION_EXPAND_ALL),b.changeWorkingState(!0),b.containerSelector.empty(),b.btnExpandAll.hide(),b.btnCollapseAll.show(),b.loadingIcon.show(),b.getComments(h.GET_ALL_VALUE).then(function(a){var c=b.countCommentAndReplies(a.data),d=c.total;return b.updateCommentCount(d,a.total),b.renderComment(a.data,!0),M.util.js_complete(h.ACTION_EXPAND_ALL),!0}).fail(function(a){return M.util.js_complete(h.ACTION_EXPAND_ALL),b.showError(a.message),!1})}),b.btnCollapseAll.click(function(a){a.preventDefault(),M.util.js_pending(h.ACTION_COLLAPSE_ALL),b.changeWorkingState(!0),b.loadingIcon.show(),b.btnCollapseAll.hide(),b.btnExpandAll.show(),b.containerSelector[0].innerHTML="",b.getComments(b.numberToShow).then(function(a){var c=b.countCommentAndReplies(a.data),d=c.commentCount,e=c.totalDelete;return 0!==d||0!==e?(b.btnExpandAll.show(),b.updateCommentCount(d,a.total),b.renderComment(a.data,!1)):(b.loadingIcon.hide(),b.changeWorkingState(!1),b.updateCommentCount(0,0)),M.util.js_complete(h.ACTION_COLLAPSE_ALL),!0}).fail(function(a){return M.util.js_complete(h.ACTION_COLLAPSE_ALL),b.showError(a.message),!1})}),b.addComment.click(function(c){c.preventDefault(),M.util.js_pending(h.ACTION_CREATE),b.changeWorkingState(!0),b.loadingIcon.show(),a(h.SELECTOR.COMMENT_ERROR).addClass("hide"),a(h.SELECTOR.NO_COMMENT).hide();var d=h.ROOT_COMMENT_VALUE,e=b.questionId+"_"+d,f=b.formSelector,g=b.convertFormToJson(f);if(0===g["message[text]"].length){var i=f.find(h.SELECTOR.ATTO_EDITOR_WRAP);return 0===i.length||i.hasClass("error")||(i.addClass("error"),i.prepend('<span class="error" tabindex="0">'+b.string.required+"</span>")),M.util.js_complete(h.ACTION_CREATE),!1}var j={replyto:d,message:{text:g["message[text]"],format:g["message[format]"]}};return b.createComment(j).then(function(a){M.util.js_pending(h.ACTION_CLEAR_FORM),setTimeout(function(){f.trigger("reset"),f.find("#id_editor_question_"+e+"editable").empty(),f.find(h.SELECTOR.TEXTAREA).trigger("change"),M.util.js_complete(h.ACTION_CLEAR_FORM)});var c=b.convertForTemplate(a,!0);return f.find(h.SELECTOR.SUBMIT_BUTTON).addClass("disabled"),b.appendComment(c,b.elementSelector.find(h.SELECTOR.CONTAINER_REPLIES),!1),M.util.js_complete(h.ACTION_CREATE),!0}).fail(function(a){b.handleFailWhenCreateComment(a,j),M.util.js_complete(h.ACTION_CREATE)}),!0}),a(h.SELECTOR.COMMENT_FILTER_ITEM).on("click",function(c){if(c.preventDefault(),!b.workingState){var d=b.string.sort.asc,e=b.string.sort.desc,f=a(this).find(h.SELECTOR.COMMENT_FILTER_NAME),g=a(this).find(h.SELECTOR.COMMENT_FILTER_TYPE),i=a(this).data("type"),j=a(this).attr("data-order"),k=a(this).hasClass("current"),l=a(this).attr("data-asc-string"),m=a(this).attr("data-desc-string");j="desc"===j?"asc":"desc",a(this).attr("data-order",j),k||a(this).addClass("current"),"desc"===j?(f.attr("title",l),f.attr("alt",l),g.attr("title",e),g.attr("alt",e)):(f.attr("title",m),f.attr("alt",m),g.attr("title",d),g.attr("alt",d)),a(h.SELECTOR.COMMENT_FILTER_ITEM).not(this).each(function(){var b=a(this),c=a(this).find(h.SELECTOR.COMMENT_FILTER_NAME),e=a(this).find(h.SELECTOR.COMMENT_FILTER_TYPE),f=a(this).attr("data-asc-string");b.attr("data-order","desc"),b.removeClass("filter-asc"),b.removeClass("filter-desc"),b.removeClass("current"),c.attr("title",f),c.attr("alt",f),e.attr("title",d),e.attr("alt",d)}),"desc"===j?(a(this).removeClass("filter-asc"),a(this).addClass("filter-desc")):(a(this).removeClass("filter-desc"),a(this).addClass("filter-asc"));var n=i+"_"+j;b.setSort(n),b.expand?b.btnExpandAll.trigger("click"):b.btnCollapseAll.trigger("click")}})},getComments:function(a){var b=this,d=b.getParamsBeforeCallApi({numbertoshow:a,sort:b.sortFeature}),e=c.call([{methodname:h.ACTION_GET_ALL,args:d}]);return e[0]},getParamsBeforeCallApi:function(a){var b=this;return a.questionid=b.questionId,a.cmid=b.cmId,a},showError:function(b){var c=this;M.util.js_pending(h.ACTION_SHOW_ERROR),a.when(c.string.error).done(function(a){c.showDialog(a,b),c.changeWorkingState(!1),M.util.js_complete(h.ACTION_SHOW_ERROR)})},showDialog:function(a,b){var c=this,e=c.dialogue;return e?(e.title.html(a),e.body.html(b),void e.show()):void d.create({type:d.types.CANCEL,title:a,body:b}).done(function(a){e=a,e.show(),e.getRoot().on(g.hidden,{},function(){location.reload()})})},updateCommentCount:function(c,d){M.util.js_pending(h.ACTION_UPDATE_COMMENT_COUNT);var e=this;d===-1?d=e.lastTotal:e.lastTotal=d,c===-1?c=e.lastCurrentCount:e.lastCurrentCount=c;var f=b.get_string("current_of_total","studentquiz",{current:c,total:d}),g=a(h.SELECTOR.NO_COMMENT),i=a(h.SELECTOR.COMMENT_FILTER),j=e.checkEmptyElement(a(h.SELECTOR.CONTAINER_REPLIES));0===e.lastCurrentCount&&j&&e.isNoComment?(a(h.SELECTOR.CONTAINER_REPLIES).hide(),i.hide(),g.show()):(a(h.SELECTOR.CONTAINER_REPLIES).show(),g.hide(),i.show()),a.when(f).done(function(a){e.elementSelector.find(h.SELECTOR.COMMENT_COUNT).text(a),M.util.js_complete(h.ACTION_UPDATE_COMMENT_COUNT)})},renderComment:function(a,b){var c=this;M.util.js_pending(h.ACTION_RENDER_COMMENT),a=c.convertForTemplate(a,b),e.render(h.TEMPLATE_COMMENTS,{comments:a}).done(function(b){c.containerSelector[0].innerHTML=b,c.loadingIcon.hide();for(var d=0;d<a.length;d++)c.bindCommentEvent(a[d]);c.changeWorkingState(!1),M.util.js_complete(h.ACTION_RENDER_COMMENT)})},bindCommentEvent:function(b){var c=this,d=c.containerSelector.find(h.SELECTOR.COMMENT_ID+b.id),e=0;if(b.root&&b.hasOwnProperty("replies"))for(e;e<b.replies.length;e++){var f=b.replies[e];f.hasOwnProperty("expand")||(f.expand=!0),f.hasOwnProperty("root")||(f.root=!1),c.bindReplyEvent(f,d)}d.find(h.SELECTOR.BTN_DELETE).click(function(a){c.bindDeleteEvent(b),a.preventDefault()}),d.find(h.SELECTOR.BTN_REPLY).click(function(a){a.preventDefault(),c.getFragmentFormReplyEvent(b)}),d.find(h.SELECTOR.EXPAND_LINK).click(function(a){a.preventDefault(),c.bindExpandEvent(b)}),d.find(h.SELECTOR.COLLAPSE_LINK).click(function(a){a.preventDefault(),c.bindCollapseEvent(b)}),d.find(h.SELECTOR.BTN_REPORT).click(function(b){b.preventDefault(),window.location=a(this).data("href")})},bindReplyEvent:function(b,c){var d=this,e=c.find(h.SELECTOR.COMMENT_ID+b.id);e.find(h.SELECTOR.BTN_DELETE_REPLY).click(function(a){d.bindDeleteEvent(b),a.preventDefault()}),e.find(h.SELECTOR.BTN_REPORT).click(function(b){b.preventDefault(),window.location=a(this).data("href")})},changeWorkingState:function(a){var b=a?"hidden":"visible",c=this;c.workingState=a,c.btnExpandAll.prop("disabled",a),c.btnCollapseAll.prop("disabled",a),c.elementSelector.find(h.SELECTOR.BTN_REPLY).prop("disabled",a),c.elementSelector.find(h.SELECTOR.BTN_DELETE).prop("disabled",a),c.elementSelector.find(h.SELECTOR.BTN_DELETE_REPLY).prop("disabled",a),c.elementSelector.find(h.SELECTOR.BTN_REPORT).prop("disabled",a),c.elementSelector.find(h.SELECTOR.EXPAND_LINK).css("visibility",b),c.elementSelector.find(h.SELECTOR.COLLAPSE_LINK).css("visibility",b),c.deleteDialog&&c.deleteDialog.getFooter().find('button[data-action="yes"]').prop("disabled",a),a?c.addComment.prop("disabled",a):c.lastFocusElement&&(c.lastFocusElement.focus(),c.lastFocusElement=null)},countCommentAndReplies:function(a){var b=0,c=0,d=0,e=0;a.constructor!==Array&&(a=[a]);for(var f=0;f<a.length;f++){var g=a[f];0==g.deletedtime?b++:c++;for(var h=0;h<g.replies.length;h++){var i=g.replies[h];0==i.deletedtime?d++:e++}}return{total:b+d,totalDelete:c+e,commentCount:b,deleteCommentCount:c,replyCount:d,deleteReplyCount:e}},expandComment:function(a){var b=this,d=b.getParamsBeforeCallApi({commentid:a}),e=c.call([{methodname:h.ACTION_EXPAND,args:d}]);return e[0]},bindExpandEvent:function(b){var c=this,d=c.elementSelector.find(h.SELECTOR.COMMENT_ID+b.id),f=h.ACTION_EXPAND;M.util.js_pending(f),c.changeWorkingState(!0);var g=c.loadingIcon.clone().show();d.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER).append(g),a(c).hide(),c.expandComment(b.id).then(function(g){var i=c.convertForTemplate(g,!0),j=d.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER_TO_ITEM).length,k=c.countCommentAndReplies(i).replyCount,l=c.lastCurrentCount+k-j,m=c.lastTotal+(i.numberofreply-b.numberofreply);return b.deleted&&!i.deleted&&(l++,m++),!b.deleted&&i.deleted&&(l--,m--),l===m&&(c.btnExpandAll.hide(),c.btnCollapseAll.show()),c.updateCommentCount(l,m),e.render(h.TEMPLATE_COMMENT,i).done(function(b){var e=a(b);return d.replaceWith(e),c.lastFocusElement=e.find(h.SELECTOR.COLLAPSE_LINK),c.bindCommentEvent(g),c.changeWorkingState(!1),M.util.js_complete(f),!0})}).fail(function(a){M.util.js_complete(f),c.showError(a.message)})},bindCollapseEvent:function(a){var b=this,c=b.elementSelector.find(h.SELECTOR.COMMENT_ID+a.id),d=c.find(h.SELECTOR.COMMENT_REPLIES_TEXT).length;b.updateCommentCount(b.lastCurrentCount-d,-1),a.numberofreply=d,c.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER).empty(),a.deleted?c.find(".studentquiz-comment-delete-content").html(a.shortcontent):c.find(h.SELECTOR.COMMENT_TEXT).html(a.shortcontent),c.find(h.SELECTOR.COLLAPSE_LINK).hide(),c.find(h.SELECTOR.EXPAND_LINK).show().focus(),a.expanded=!1},convertForTemplate:function(a,b){var c=this,d=!1;a.constructor!==Array&&(a=[a],d=!0);for(var e=0;e<a.length;e++){var f=a[e];if(f.expanded=b,f.canviewdeleted=c.canViewDeleted,f.hasOwnProperty("replies")||(f.replies=[]),c.setHasComment(f.hascomment),f.highlight=f.id===c.highlight,c.referer&&f.reportlink&&(f.reportlink=c.buildRefererReportLink(f.reportlink,f.id)),f.root)for(var g=0;g<f.replies.length;g++){var h=f.replies[g];h.expanded=!0,h.canviewdeleted=c.canViewDeleted,h.hasOwnProperty("replies")||(h.replies=[]),h.highlight=h.id===c.highlight,c.referer&&h.reportlink&&(h.reportlink=c.buildRefererReportLink(h.reportlink,h.id))}}return d?a[0]:a},convertFormToJson:function(b){var c={};return b.find(":input").each(function(){var b=a(this).prop("type"),d=a(this).attr("name");(("checkbox"===b||"radio"===b)&&this.checked||"button"!==b&&"submit"!==b)&&(c[d]=a(this).val())}),c},createComment:function(a){var b=this;a=b.getParamsBeforeCallApi(a);var d=c.call([{methodname:h.ACTION_CREATE,args:a}]);return d[0]},appendComment:function(b,c,d){var f=this;M.util.js_pending(h.ACTION_APPEND_COMMENT),e.render(h.TEMPLATE_COMMENT,b).done(function(e){var g=a(e);c.append(g),f.lastCurrentCount?f.updateCommentCount(f.lastCurrentCount+1,f.lastTotal+1):(a(h.SELECTOR.COMMENT_FILTER).removeClass(h.SELECTOR.COMMENT_FILTER_HIDE),f.updateCommentCount(1,1),f.btnExpandAll.prop("disabled",!0),f.btnExpandAll.hide(),f.btnCollapseAll.prop("disabled",!1),f.btnCollapseAll.show(),f.expand=!0,f.isNoComment=!1),d?f.bindReplyEvent(b,g.parent()):f.bindCommentEvent(b),f.loadingIcon.hide(),f.changeWorkingState(!1),M.util.js_complete(h.ACTION_APPEND_COMMENT)})},loadFragmentForm:function(a,b){var c=this;M.util.js_pending(h.ACTION_LOAD_FRAGMENT_FORM);var d=c.getParamsBeforeCallApi({replyto:b.id,cancelbutton:!0,forcecommenting:c.forceCommenting}),g=c.formSelector.find(h.SELECTOR.ATTO_EDITOR_WRAP);0!==g.length&&g.hasClass("error")&&(g.removeClass("error"),g.find("#id_error_message_5btext_5d").remove()),f.loadFragment("mod_studentquiz",h.FRAGMENT_FORM_CALLBACK,c.contextId,d).done(function(d,f){e.replaceNodeContents(a,d,f);var g="#id_editor_question_"+c.questionId+"_"+b.id+"editable";a.find(g).focus(),c.bindFragmentFormEvent(a,b),M.util.js_complete(h.ACTION_LOAD_FRAGMENT_FORM)})},bindFragmentFormEvent:function(a,b){var c=this,d=a.find(h.SELECTOR.COMMENT_AREA_FORM);a.find(h.SELECTOR.SUBMIT_BUTTON).click(function(e){e.preventDefault(),c.changeWorkingState(!0);var f=c.convertFormToJson(d);if(0===f["message[text]"].length)return!0;var g=c.loadingIcon.clone().show();return g.appendTo(a),d.hide(),c.createReplyComment(a,b,d,f),!0}),c.fragmentFormCancelEvent(d),c.bindEditorEvent(a)},createReplyComment:function(b,c,d,e){var f=this,g={replyto:c.id,message:{text:e["message[text]"],format:e["message[format]"]}};M.util.js_pending(h.ACTION_CREATE_REPLY),f.createComment(g).then(function(d){a(h.SELECTOR.COMMENT_ERROR).addClass("hide");var e=f.elementSelector.find(h.SELECTOR.COMMENT_ID+c.id),g=e.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER);c.numberofreply++;var i=parseInt(e.find(h.SELECTOR.COMMENT_COUNT_NUMBER).text())+1;e.find(h.SELECTOR.COMMENT_COUNT_NUMBER).text(i),e.find(h.SELECTOR.COMMENT_COUNT_TEXT).html(1===i?f.string.reply:f.string.replies),b.empty();var j=f.convertForTemplate(d,!0);return f.appendComment(j,g,!0),M.util.js_complete(h.ACTION_CREATE_REPLY),!0}).fail(function(a){f.handleFailWhenCreateComment(a,g),M.util.js_complete(h.ACTION_CREATE_REPLY)})},handleFailWhenCreateComment:function(a,b){var c=this;c.showError(a.message);var d=h.SELECTOR.COMMENT_ID+b.replyto+" "+h.SELECTOR.FRAGMENT_FORM;c.elementSelector.find(d).empty()},getFragmentFormReplyEvent:function(a){var b=this,c=b.elementSelector.find(h.SELECTOR.COMMENT_ID+a.id),d=c.find(h.SELECTOR.FRAGMENT_FORM).first(),e=b.loadingIcon.clone().show();d.append(e),b.loadFragmentForm(d,a),b.changeWorkingState(!0)},fragmentFormCancelEvent:function(a){var b=this,c=a.find("#id_cancel");c.click(function(c){c.preventDefault();var d=a.closest(h.SELECTOR.COMMENT_ITEM);b.lastFocusElement=d.find(h.SELECTOR.BTN_REPLY),b.changeWorkingState(!1),a.parent().empty()})},bindDeleteEvent:function(b){var c=this;c.deleteTarget=b,c.deleteDialog?c.deleteDialog.show():(c.changeWorkingState(!0),d.create({type:d.types.DEFAULT,title:c.string.deletecomment,body:c.string.confirmdeletecomment,footer:'<button class="btn btn-primary" type="button" data-action="yes" title="'+c.string.deletecomment+'">'+c.string.deletetext+'</button><button class="btn btn-secondary" type="button" data-action="no" title="'+c.string.cancel+'">'+c.string.cancel+"</button>"}).done(function(d){c.deleteDialog=d,d.getFooter().find('button[data-action="no"]').click(function(a){a.preventDefault(),d.hide()}),d.getFooter().find('button[data-action="yes"]').click(function(f){f.preventDefault(),M.util.js_pending(h.ACTION_DELETE),c.changeWorkingState(!0),c.deleteComment(c.deleteTarget.id).then(function(f){if(!f.success)return c.showError(f.message),!0;var g=c.convertForTemplate(f.data,c.deleteTarget.expanded),i=a(h.SELECTOR.COMMENT_ID+g.id),j=1;return c.updateCommentCount(c.lastCurrentCount-j,c.lastTotal-j),g.root||(g.expanded=!0),e.render(h.TEMPLATE_COMMENT,g).done(function(d){var e=a(d);if(!g.root){var f=i.parent(),j=f.closest(h.SELECTOR.COMMENT_ITEM).find(h.SELECTOR.TOTAL_REPLY),k=j.find(h.SELECTOR.COMMENT_COUNT_NUMBER),l=parseInt(k.text())-1;j.find(h.SELECTOR.COMMENT_COUNT_NUMBER).text(l),j.find(h.SELECTOR.COMMENT_COUNT_TEXT).html(1===l?c.string.reply:c.string.replies)}var m=i.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER).clone(!0);i.replaceWith(e),e.find(h.SELECTOR.COMMENT_REPLIES_CONTAINER).replaceWith(m),c.deleteTarget.root?c.bindCommentEvent(b):c.bindReplyEvent(b,e.parent()),c.changeWorkingState(!1),M.util.js_complete(h.ACTION_DELETE)}),d.hide(),!0}).fail(function(a){return c.showError(a.message),!1})}),d.getRoot().on(g.hidden,function(){var b=a(h.SELECTOR.COMMENT_ID+c.deleteTarget.id);c.deleteTarget.root?b.find(h.SELECTOR.BTN_DELETE).first().focus():b.find(h.SELECTOR.BTN_DELETE_REPLY).first().focus()}),d.getRoot().on(g.shown,function(){c.changeWorkingState(!1)}),d.show(),c.changeWorkingState(!1)}))},deleteComment:function(a){var b=this,d=b.getParamsBeforeCallApi({commentid:a}),e=c.call([{methodname:h.ACTION_DELETE,args:d}]);return e[0]},bindEditorEvent:function(b){var c=this;M.util.js_pending("init_editor"),c.triggerAttoNoContent(b),b.find(h.SELECTOR.ATTO.TOOLBAR).fadeIn();var d="text_change_"+Date.now(),e=b.find(h.SELECTOR.TEXTAREA),f=e.attr("id")+"editable",g=document.getElementById(f),i=new MutationObserver(function(e){e.forEach(function(e){"attributes"!==e.type||"style"!==e.attributeName&&"hidden"!==e.attributeName||(M.util.js_pending(d),h.EMPTY_CONTENT.indexOf(a("#"+f).html())>-1?c.triggerAttoNoContent(b):c.triggerAttoHasContent(b),M.util.js_complete(d))})});i.observe(g,{attributes:!0,childList:!0,subtree:!0}),e.change(function(){M.util.js_pending(d),h.EMPTY_CONTENT.indexOf(a("#"+f).html())>-1?c.triggerAttoNoContent(b):c.triggerAttoHasContent(b),M.util.js_complete(d)}),M.util.js_complete("init_editor");var j=setInterval(function(){b.find('textarea[id^="id_message"]').trigger("change")},350);setTimeout(function(){clearInterval(j)},5e3)},checkEmptyElement:function(a){return 0===a.children().length},setHasComment:function(b){var c=this,d=a(h.SELECTOR.CONTAINER),e=h.HAS_COMMENT_CLASS;c.forceCommenting?(c.hasComment=b,c.hasComment?d.addClass(e):d.removeClass(e)):(c.hasComment=!0,d.addClass(e))},parseQueryString:function(a){for(var b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("="),f=decodeURIComponent(e[0]),g=decodeURIComponent(e[1]);"undefined"==typeof c[f]?c[f]=decodeURIComponent(g):"string"==typeof c[f]?c[f]=[c[f],decodeURIComponent(g)]:c[f].push(decodeURIComponent(g))}return c},scrollToElement:function(b,c){if(b.length){"undefined"==typeof c&&(c=1e3);var d=b.offset().top;a("html,body").animate({scrollTop:d},c)}},buildRefererReportLink:function(a,b){var c=this,d=decodeURIComponent(c.referer);return a+="&referer="+encodeURIComponent(d+"&highlight="+b)},triggerAttoHasContent:function(a){var b=a.find(h.SELECTOR.ATTO.CONTENT_WRAP),c=a.find(h.SELECTOR.SUBMIT_BUTTON);c.removeClass("disabled"),c.prop("disabled",!1),b.attr("data-placeholder",""),b.addClass(h.ATTO_CONTENT_TYPE.HAS_CONTENT),b.removeClass(h.ATTO_CONTENT_TYPE.NO_CONTENT)},triggerAttoNoContent:function(a){var b=a.attr("data-textarea-placeholder"),c=a.find(h.SELECTOR.ATTO.CONTENT_WRAP),d=a.find(h.SELECTOR.SUBMIT_BUTTON);d.addClass("disabled"),d.prop("disabled",!0),c.attr("data-placeholder",b),c.addClass(h.ATTO_CONTENT_TYPE.NO_CONTENT),c.removeClass(h.ATTO_CONTENT_TYPE.HAS_CONTENT)},setSort:function(b){var c=this;a.inArray(b,c.sortable)!==-1&&(c.sortFeature=b)}}},generate:function(a){h.get().init(a)}};return h});
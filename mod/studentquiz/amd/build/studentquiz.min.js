define(["jquery"],function(a){function b(){a(".studentquiz_behaviour .show_more").off("click").on("click",function(){a(".studentquiz_behaviour .comment_list div").removeClass("hidden"),a(this).addClass("hidden"),a(".studentquiz_behaviour .show_less").removeClass("hidden")}),a(".studentquiz_behaviour .show_less").off("click").on("click",function(){a(".studentquiz_behaviour .comment_list > div").each(function(b){b>10&&!a(this).hasClass("button_controls")&&a(this).addClass("hidden")}),a(this).addClass("hidden"),a(".studentquiz_behaviour .show_more").removeClass("hidden")});var b=a(".studentquiz_behaviour .remove_action");b.off("click").on("click",function(){h(this)}),b.on("keypress",function(a){void 0!==a.keyCode&&13===a.keyCode&&(a.preventDefault(),h(this))})}function c(c,d,e){var f=M.cfg.wwwroot+"/mod/studentquiz/comment_list.php?questionid=";f+=c+"&cmid="+e+"&sesskey="+M.cfg.sesskey,a.get(f,function(a){d.html(a),b()})}function d(){""!=a(".add_comment_field").val()?e():f()}function e(){a(window).on("beforeunload",function(){return a(".studentquiz_behaviour > .comments > .comment_error_unsaved").removeClass("hide"),!0})}function f(){a(".studentquiz_behaviour > .comments > .comment_error_unsaved").addClass("hide"),a(window).off("beforeunload")}function g(b){var c=a(b).attr("data-rate"),d=a(b),e=a(b).closest("form").find(".cmid_field"),f=e.attr("value");a.post(M.cfg.wwwroot+"/mod/studentquiz/save.php",{save:"rate",cmid:f,questionid:a(b).attr("data-questionid"),sesskey:M.cfg.sesskey,rate:c},function(){var b=d.closest(".rating").children("span");b.removeClass("star"),b.addClass("star-empty"),b.each(function(){a(this).attr("data-rate")<=c&&(a(this).removeClass("star-empty"),a(this).addClass("star"))}),a(".studentquiz_behaviour > .rate > .rate_error").addClass("hide")})}function h(b){var d=a(b).closest("form").find(".cmid_field"),e=d.attr("value"),f=a(b).attr("data-question_id"),g=a(b).closest(".comments").children(".comment_list");a.post(M.cfg.wwwroot+"/mod/studentquiz/remove.php",{id:a(b).attr("data-id"),cmid:e,sesskey:M.cfg.sesskey},function(){c(f,g,e)}),a(".studentquiz_behaviour .add_comment").focus()}return{initialise:function(e,f){a(".studentquiz_behaviour .add_comment").off("click").on("click",function(){var b=a(this).closest(".comments"),d=b.find(".add_comment_field"),e=d.attr("name").substr(1),f=a(this).closest("form").find(".cmid_field"),g=f.attr("value"),h=b.children(".comment_list");""!=d.val()&&a.post(M.cfg.wwwroot+"/mod/studentquiz/save.php",{save:"comment",cmid:g,questionid:e,sesskey:M.cfg.sesskey,text:d.val()},function(){d.val(""),d.trigger("keyup"),c(e,h,g),a(".studentquiz_behaviour > .comments > .comment_error").addClass("hide")})});var h=a(".studentquiz_behaviour .rate .rating .rateable");h.off("click").on("click",function(){g(this)}),h.on("keypress",function(a){13!==a.keyCode&&32!==a.keyCode||(a.preventDefault(),g(this))}),a('input[name="next"], input[name="previous"], input[name="finish"]').off("click").on("click",function(){var b=a(this),c=!a('.im-controls input[type="submit"]').length||a('.im-controls input[type="submit"]').filter(function(){return this.name.match(/^q.+-submit$/)}).is(":disabled");if(c){var d=a(".rating span").hasClass("star"),g=a(".studentquiz_behaviour .comment_list > div").hasClass("fromcreator");return e&&(d||(a(".studentquiz_behaviour > .rate > .rate_error").removeClass("hide"),a(".studentquiz_behaviour .rate .rating .rateable:first-child").focus())),f&&(g||a(".studentquiz_behaviour > .comments > .comment_error").removeClass("hide")),!(e&&!d||f&&!g)&&(b.submit(),!0)}return b.submit(),!0}),a(".add_comment_field").on("keyup",d),b()},setFocus:function(){a(document).ready(function(){var b=a("#categoryquestions .iconsort");b&&b.parent().focus()})}}});
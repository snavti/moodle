define ("mod_studentquiz/comment_area",["jquery","core/str","core/ajax","core/modal_factory","core/templates","core/fragment","core/modal_events"],function(n,e,o,i,E,d,r){var a={EMPTY_CONTENT:["<br><p><br></p>","<p><br></p>","<br>",""],ROOT_COMMENT_VALUE:0,GET_ALL_VALUE:0,TEMPLATE_COMMENTS:"mod_studentquiz/comments",TEMPLATE_COMMENT:"mod_studentquiz/comment",ACTION_CREATE:"mod_studentquiz_create_comment",ACTION_CREATE_REPLY:"mod_studentquiz_create_reply",ACTION_GET_ALL:"mod_studentquiz_get_comments",ACTION_EXPAND:"mod_studentquiz_expand_comment",ACTION_DELETE:"mod_studentquiz_delete_comment",ACTION_EDIT:"mod_studentquiz_edit_comment",ACTION_LOAD_FRAGMENT_FORM:"mod_studentquiz_load_fragment_form",ACTION_LOAD_FRAGMENT_EDIT_FORM:"mod_studentquiz_load_fragment_edit_form",ACTION_EXPAND_ALL:"action_expand_all",ACTION_COLLAPSE_ALL:"action_collapse_all",ACTION_RENDER_COMMENT:"action_render_comment",ACTION_APPEND_COMMENT:"action_append_comment",ACTION_EDITOR_INIT:"action_editor_init",ACTION_INIT:"action_init",ACTION_UPDATE_COMMENT_COUNT:"action_update_comment_count",ACTION_CLEAR_FORM:"action_clear_form",ACTION_SHOW_ERROR:"action_show_error",FRAGMENT_FORM_CALLBACK:"commentform",FRAGMENT_EDIT_FORM_CALLBACK:"commenteditform",HAS_COMMENT_CLASS:"has-comment",ATTO_CONTENT_TYPE:{HAS_CONTENT:"has-content",NO_CONTENT:"no-content"},SELECTOR:{CONTAINER:".studentquiz-comment-container",EXPAND_ALL:".studentquiz-comment-expand",COLLAPSE_ALL:".studentquiz-comment-collapse",SUBMIT_BUTTON:"#id_submitbutton",CONTAINER_REPLIES:".studentquiz-container-replies",COMMENT_REPLIES_CONTAINER:".studentquiz-comment-replies",COMMENT_COUNT:".studentquiz-comment-postcount",COMMENT_TEXT_CONTAINER:".studentquiz-comment-text",COMMENT_TEXT:".studentquiz-comment-text-inside",COMMENT_HISTORY:".studentquiz-comment-history",COMMENT_REPLIES_TEXT:".studentquiz-comment-replies .studentquiz-comment-text .studentquiz-comment-text-inside",LOADING_ICON:".studentquiz-comment-loading",COMMENT_AREA_FORM:"div.comment-area-form",FORM_SELECTOR:".studentquiz-comment-postform > div.comment-area-form",NO_COMMENT:".no-comment",COLLAPSE_LINK:".studentquiz-comment-collapselink",EXPAND_LINK:".studentquiz-comment-expandlink",COMMENT_ITEM:".studentquiz-comment-item",COMMENT_REPLIES_CONTAINER_TO_ITEM:".studentquiz-comment-replies .studentquiz-comment-item",FRAGMENT_FORM:".studentquiz-comment-postfragmentform",BTN_DELETE:".studentquiz-comment-btndelete",BTN_REPLY:".studentquiz-comment-btnreply",BTN_DELETE_REPLY:".studentquiz-comment-btndeletereply",ATTO_EDITOR_WRAP:".editor_atto_wrap",TEXTAREA:"textarea[id^=\"id_editor_question_\"]",COMMENT_COUNT_NUMBER:".studentquiz-comment-count-number",COMMENT_COUNT_TEXT:".studentquiz-comment-count-text",ATTO:{CONTENT_WRAP:".editor_atto_content_wrap",CONTENT:".editor_atto_content",TOOLBAR:".editor_atto_toolbar"},COMMENT_ID:"#comment_",SPAN_COMMENT_ID:"#c",TOTAL_REPLY:".studentquiz-comment-totalreply",COMMENT_FILTER:".studentquiz-comment-filter",COMMENT_FILTER_HIDE:".hide-comment-filter",COMMENT_ERROR:".studentquiz-comment-container .comment-error",BTN_REPORT:".studentquiz-comment-btnreport",COMMENT_FILTER_ITEM:".studentquiz-comment-filter-item",COMMENT_FILTER_NAME:".studentquiz-comment-filter-name",COMMENT_FILTER_TYPE:".studentquiz-comment-filter-type",BTN_EDIT:".studentquiz-comment-btnedit",BTN_EDIT_REPLY:".studentquiz-comment-btneditreply",ATTO_HTML_BUTTON:"button.atto_html_button",POST_FOOTER:".studentquiz-comment-postfooter"},get:function get(){return{elementSelector:null,btnExpandAll:null,btnCollapseAll:null,addComment:null,containerSelector:null,questionId:null,dialogue:null,loadingIcon:null,lastFocusElement:null,formSelector:null,contextId:null,userId:null,string:{},deleteDialog:null,deleteTarget:null,numberToShow:5,cmId:null,countServerData:[],lastCurrentCount:0,lastTotal:0,expand:!1,forceCommenting:!1,canViewDeleted:!1,hasComment:!1,referer:null,highlight:0,sortFeature:null,sortable:[],workingState:!1,isNoComment:!1,init:function init(e){M.util.js_pending(a.ACTION_INIT);var t=this;t.elementSelector=n("#"+n.escapeSelector(e.id));var o=t.elementSelector;t.btnExpandAll=o.find(a.SELECTOR.EXPAND_ALL);t.btnCollapseAll=o.find(a.SELECTOR.COLLAPSE_ALL);t.addComment=o.find(a.SELECTOR.SUBMIT_BUTTON);t.containerSelector=o.find(a.SELECTOR.CONTAINER_REPLIES);t.loadingIcon=o.find(a.SELECTOR.LOADING_ICON);t.formSelector=o.find(a.SELECTOR.FORM_SELECTOR);t.questionId=parseInt(o.data("questionid"));t.contextId=parseInt(o.data("contextid"));t.userId=parseInt(o.data("userid"));t.numberToShow=parseInt(o.data("numbertoshow"));t.cmId=parseInt(o.data("cmid"));t.countServerData={count:e.count,total:e.total};t.expand=e.expand||!1;t.referer=o.data("referer");t.sortFeature=e.sortfeature;t.sortable=o.data("sortable");t.string=o.data("strings");t.forceCommenting=e.forcecommenting;t.canViewDeleted=e.canviewdeleted;t.isNoComment=e.isnocomment;t.allowSelfCommentRating=e.allowselfcommentrating;t.initServerRender();if(e.allowselfcommentrating){t.initBindEditor()}t.bindEvents();M.util.js_complete(a.ACTION_INIT)},initServerRender:function initServerRender(){var e=this;e.changeWorkingState(!0);n(a.SELECTOR.COMMENT_ITEM).each(function(){var t=n(this).data("id"),o=n(this).find(a.SELECTOR.SPAN_COMMENT_ID+t),i=[];if(e.expand){i=o.data("replies")||[]}var E={id:n(this).data("id"),deleted:o.data("deleted"),numberofreply:o.data("numberofreply"),expanded:e.expand,replies:i,root:!0};e.bindCommentEvent(E)});var t=e.expand?e.countServerData.total:e.countServerData.count.commentcount;e.updateCommentCount(t,e.countServerData.total);if(e.expand){e.btnExpandAll.hide();e.btnCollapseAll.show()}else{e.btnExpandAll.show();e.btnCollapseAll.hide()}var o=window.location.search.substring(1),i=e.parseQueryString(o);e.highlight=parseInt(i.highlight)||0;if(0!==e.highlight){var E=n(a.SELECTOR.COMMENT_ID+e.highlight);if(E.length){e.scrollToElement(E)}}e.changeWorkingState(!1)},initBindEditor:function initBindEditor(){var e=this,t=!1;M.util.js_pending(a.ACTION_EDITOR_INIT);var n=setInterval(function(){if(0!==e.formSelector.find(a.SELECTOR.ATTO.CONTENT).length){e.bindEditorEvent(e.formSelector);t=!0;clearInterval(n);M.util.js_complete(a.ACTION_EDITOR_INIT)}},500),o=setInterval(function(){if(t){e.checkEditorContent(e.formSelector);clearInterval(o)}},1e3)},bindEvents:function bindEvents(){var t=this;t.btnExpandAll.click(function(n){n.preventDefault();M.util.js_pending(a.ACTION_EXPAND_ALL);t.changeWorkingState(!0);t.containerSelector.empty();t.btnExpandAll.hide();t.btnCollapseAll.show();t.loadingIcon.show();t.getComments(a.GET_ALL_VALUE).then(function(e){var n=t.countCommentAndReplies(e.data),o=n.total;t.updateCommentCount(o,e.total);t.renderComment(e.data,!0);M.util.js_complete(a.ACTION_EXPAND_ALL);return!0}).fail(function(e){M.util.js_complete(a.ACTION_EXPAND_ALL);t.showError(e.message);return!1})});t.btnCollapseAll.click(function(n){n.preventDefault();M.util.js_pending(a.ACTION_COLLAPSE_ALL);t.changeWorkingState(!0);t.loadingIcon.show();t.btnCollapseAll.hide();t.btnExpandAll.show();t.containerSelector[0].innerHTML="";t.getComments(t.numberToShow).then(function(e){var n=t.countCommentAndReplies(e.data),o=n.commentCount,i=n.totalDelete;if(0!==o||0!==i){t.btnExpandAll.show();t.updateCommentCount(o,e.total);t.renderComment(e.data,!1)}else{t.loadingIcon.hide();t.changeWorkingState(!1);t.updateCommentCount(0,0)}M.util.js_complete(a.ACTION_COLLAPSE_ALL);return!0}).fail(function(e){M.util.js_complete(a.ACTION_COLLAPSE_ALL);t.showError(e.message);return!1})});t.addComment.click(function(o){o.preventDefault();M.util.js_pending(a.ACTION_CREATE);t.changeWorkingState(!0);t.loadingIcon.show();n(a.SELECTOR.COMMENT_ERROR).addClass("hide");n(a.SELECTOR.NO_COMMENT).hide();var e=a.ROOT_COMMENT_VALUE,i=t.questionId+"_"+e,E=t.formSelector,d=t.convertFormToJson(E);if(0===d["message[text]"].length){var r=E.find(a.SELECTOR.ATTO_EDITOR_WRAP);if(0!==r.length&&!r.hasClass("error")){r.addClass("error");r.prepend("<span class=\"error\" tabindex=\"0\">"+t.string.required+"</span>")}M.util.js_complete(a.ACTION_CREATE);return!1}var l={replyto:e,message:{text:d["message[text]"],format:d["message[format]"]}};t.createComment(l).then(function(e){M.util.js_pending(a.ACTION_CLEAR_FORM);setTimeout(function(){E.trigger("reset");if(!E.find("#id_editor_question_"+i+"editable").is(":visible")){n(a.SELECTOR.ATTO_HTML_BUTTON).trigger("click")}E.find("#id_editor_question_"+i+"editable").empty();E.find(a.SELECTOR.TEXTAREA).trigger("change");M.util.js_complete(a.ACTION_CLEAR_FORM)});var o=t.convertForTemplate(e,!0);E.find(a.SELECTOR.SUBMIT_BUTTON).addClass("disabled");t.appendComment(o,t.elementSelector.find(a.SELECTOR.CONTAINER_REPLIES),!1);M.util.js_complete(a.ACTION_CREATE);return!0}).fail(function(n){t.handleFailWhenCreateComment(n,l);M.util.js_complete(a.ACTION_CREATE)});return!0});n(a.SELECTOR.COMMENT_FILTER_ITEM).on("click",function(o){o.preventDefault();if(t.workingState){return}var e=t.string.sort.asc,i=t.string.sort.desc,E=n(this).find(a.SELECTOR.COMMENT_FILTER_NAME),d=n(this).find(a.SELECTOR.COMMENT_FILTER_TYPE),r=n(this).data("type"),l=n(this).attr("data-order"),T=n(this).hasClass("current"),m=n(this).attr("data-asc-string"),s=n(this).attr("data-desc-string");l="desc"===l?"asc":"desc";n(this).attr("data-order",l);if(!T){n(this).addClass("current")}if("desc"===l){E.attr("title",m);E.attr("alt",m);d.attr("title",i);d.attr("alt",i)}else{E.attr("title",s);E.attr("alt",s);d.attr("title",e);d.attr("alt",e)}n(a.SELECTOR.COMMENT_FILTER_ITEM).not(this).each(function(){var t=n(this),o=n(this).find(a.SELECTOR.COMMENT_FILTER_NAME),i=n(this).find(a.SELECTOR.COMMENT_FILTER_TYPE),E=n(this).attr("data-asc-string");t.attr("data-order","desc");t.removeClass("filter-asc");t.removeClass("filter-desc");t.removeClass("current");o.attr("title",E);o.attr("alt",E);i.attr("title",e);i.attr("alt",e)});if("desc"===l){n(this).removeClass("filter-asc");n(this).addClass("filter-desc")}else{n(this).removeClass("filter-desc");n(this).addClass("filter-asc")}var C=r+"_"+l;t.setSort(C);if(t.expand){t.btnExpandAll.trigger("click")}else{t.btnCollapseAll.trigger("click")}})},getComments:function getComments(e){var t=this,n=t.getParamsBeforeCallApi({numbertoshow:e,sort:t.sortFeature}),i=o.call([{methodname:a.ACTION_GET_ALL,args:n}]);return i[0]},getParamsBeforeCallApi:function getParamsBeforeCallApi(e){var t=this;e.questionid=t.questionId;e.cmid=t.cmId;return e},showError:function showError(e){var t=this;M.util.js_pending(a.ACTION_SHOW_ERROR);n.when(t.string.error).done(function(n){t.showDialog(n,e);t.changeWorkingState(!1);M.util.js_complete(a.ACTION_SHOW_ERROR)})},showDialog:function showDialog(e,t){var n=this,o=n.dialogue;if(o){o.title.html(e);o.body.html(t);o.show();return}i.create({type:i.types.CANCEL,title:e,body:t}).done(function(e){o=e;o.show();o.getRoot().on(r.hidden,{},function(){location.reload()})})},updateCommentCount:function updateCommentCount(t,o){M.util.js_pending(a.ACTION_UPDATE_COMMENT_COUNT);var i=this;if(-1===o){o=i.lastTotal}else{i.lastTotal=o}if(-1===t){t=i.lastCurrentCount}else{i.lastCurrentCount=t}var E=e.get_string("current_of_total","studentquiz",{current:t,total:o}),d=n(a.SELECTOR.NO_COMMENT),r=n(a.SELECTOR.COMMENT_FILTER),l=i.checkEmptyElement(n(a.SELECTOR.CONTAINER_REPLIES));if(0===i.lastCurrentCount&&l&&i.isNoComment){n(a.SELECTOR.CONTAINER_REPLIES).hide();r.hide();d.show()}else{n(a.SELECTOR.CONTAINER_REPLIES).show();d.hide();r.show()}n.when(E).done(function(e){i.elementSelector.find(a.SELECTOR.COMMENT_COUNT).text(e);M.util.js_complete(a.ACTION_UPDATE_COMMENT_COUNT)})},renderComment:function renderComment(e,t){var n=this;M.util.js_pending(a.ACTION_RENDER_COMMENT);e=n.convertForTemplate(e,t);E.render(a.TEMPLATE_COMMENTS,{comments:e}).done(function(t){n.containerSelector[0].innerHTML=t;n.loadingIcon.hide();for(var o=0;o<e.length;o++){n.bindCommentEvent(e[o])}n.changeWorkingState(!1);M.util.js_complete(a.ACTION_RENDER_COMMENT)})},bindCommentEvent:function bindCommentEvent(t){var o=this,E=o.containerSelector.find(a.SELECTOR.COMMENT_ID+t.id),e=0;if(t.root&&t.hasOwnProperty("replies")){for(e;e<t.replies.length;e++){var d=t.replies[e];if(!d.hasOwnProperty("expand")){d.expand=!0}if(!d.hasOwnProperty("root")){d.root=!1}o.bindReplyEvent(d,E)}}E.find(a.SELECTOR.BTN_DELETE).click(function(n){o.bindDeleteEvent(t);n.preventDefault()});E.find(a.SELECTOR.BTN_REPLY).click(function(n){n.preventDefault();o.getFragmentFormReplyEvent(t)});E.find(a.SELECTOR.EXPAND_LINK).click(function(n){n.preventDefault();o.bindExpandEvent(t)});E.find(a.SELECTOR.COLLAPSE_LINK).click(function(n){n.preventDefault();o.bindCollapseEvent(t)});E.find(a.SELECTOR.BTN_REPORT).click(function(t){t.preventDefault();window.location=n(this).data("href")});E.find(a.SELECTOR.BTN_EDIT).click(function(n){n.preventDefault();o.getFragmentEditFormEvent(t)})},bindReplyEvent:function bindReplyEvent(t,o){var i=this,E=o.find(a.SELECTOR.COMMENT_ID+t.id);E.find(a.SELECTOR.BTN_DELETE_REPLY).click(function(n){i.bindDeleteEvent(t);n.preventDefault()});E.find(a.SELECTOR.BTN_REPORT).click(function(t){t.preventDefault();window.location=n(this).data("href")});E.find(a.SELECTOR.BTN_EDIT_REPLY).click(function(n){n.preventDefault();i.getFragmentEditFormEvent(t)})},changeWorkingState:function changeWorkingState(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,o=e?"hidden":"visible",i=this;i.workingState=e;i.btnExpandAll.prop("disabled",e);i.btnCollapseAll.prop("disabled",e);i.elementSelector.find(a.SELECTOR.BTN_REPLY).prop("disabled",e);i.elementSelector.find(a.SELECTOR.BTN_DELETE).prop("disabled",e);i.elementSelector.find(a.SELECTOR.BTN_DELETE_REPLY).prop("disabled",e);i.elementSelector.find(a.SELECTOR.BTN_REPORT).prop("disabled",e);i.elementSelector.find(a.SELECTOR.EXPAND_LINK).css("visibility",o);i.elementSelector.find(a.SELECTOR.COLLAPSE_LINK).css("visibility",o);i.elementSelector.find(a.SELECTOR.BTN_EDIT).prop("disabled",e);i.elementSelector.find(a.SELECTOR.BTN_EDIT_REPLY).prop("disabled",e);if(i.deleteDialog){i.deleteDialog.getFooter().find("button[data-action=\"yes\"]").prop("disabled",e)}if(e){i.addComment.prop("disabled",e);if(null!==t&&t instanceof n){t.hide()}}else{if(i.lastFocusElement){i.lastFocusElement.focus();i.lastFocusElement=null}i.elementSelector.find(a.SELECTOR.POST_FOOTER).show()}},countCommentAndReplies:function countCommentAndReplies(e){var t=0,n=0,o=0,E=0;if(e.constructor!==Array){e=[e]}for(var d=0,r;d<e.length;d++){r=e[d];if(0==r.deletedtime){t++}else{n++}for(var a=0,l;a<r.replies.length;a++){l=r.replies[a];if(0==l.deletedtime){o++}else{E++}}}return{total:t+o,totalDelete:n+E,commentCount:t,deleteCommentCount:n,replyCount:o,deleteReplyCount:E}},expandComment:function expandComment(e){var t=this,n=t.getParamsBeforeCallApi({commentid:e}),i=o.call([{methodname:a.ACTION_EXPAND,args:n}]);return i[0]},bindExpandEvent:function bindExpandEvent(e){var t=this,o=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),i=a.ACTION_EXPAND;M.util.js_pending(i);t.changeWorkingState(!0);var d=t.loadingIcon.clone().show();o.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).append(d);n(t).hide();t.expandComment(e.id).then(function(d){var r=t.convertForTemplate(d,!0),l=o.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER_TO_ITEM).length,T=t.countCommentAndReplies(r).replyCount,m=t.lastCurrentCount+T-l,s=t.lastTotal+(r.numberofreply-e.numberofreply);if(e.deleted&&!r.deleted){m++;s++}if(!e.deleted&&r.deleted){m--;s--}if(m===s){t.btnExpandAll.hide();t.btnCollapseAll.show()}t.updateCommentCount(m,s);return E.render(a.TEMPLATE_COMMENT,r).done(function(e){var E=n(e);o.replaceWith(E);t.lastFocusElement=E.find(a.SELECTOR.COLLAPSE_LINK);t.bindCommentEvent(d);t.changeWorkingState(!1);M.util.js_complete(i);return!0})}).fail(function(n){M.util.js_complete(i);t.showError(n.message)})},bindCollapseEvent:function bindCollapseEvent(e){var t=this,n=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),o=n.find(a.SELECTOR.COMMENT_REPLIES_TEXT).length;t.updateCommentCount(t.lastCurrentCount-o,-1);e.numberofreply=o;n.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).empty();if(e.deleted){n.find(".studentquiz-comment-delete-content").html(e.shortcontent)}else{n.find(a.SELECTOR.COMMENT_TEXT).html(e.shortcontent)}n.find(a.SELECTOR.COLLAPSE_LINK).hide();n.find(a.SELECTOR.EXPAND_LINK).show().focus();e.expanded=!1},convertForTemplate:function convertForTemplate(e,t){var n=this,o=!1;if(e.constructor!==Array){e=[e];o=!0}for(var E=0,d;E<e.length;E++){d=e[E];d.expanded=t;d.canviewdeleted=n.canViewDeleted;if(!d.hasOwnProperty("replies")){d.replies=[]}n.setHasComment(d.hascomment);d.highlight=d.id===n.highlight;if(n.referer&&d.reportlink){d.reportlink=n.buildRefererReportLink(d.reportlink,d.id)}if(d.root){for(var r=0,a;r<d.replies.length;r++){a=d.replies[r];a.expanded=!0;a.canviewdeleted=n.canViewDeleted;if(!a.hasOwnProperty("replies")){a.replies=[]}a.highlight=a.id===n.highlight;if(n.referer&&a.reportlink){a.reportlink=n.buildRefererReportLink(a.reportlink,a.id)}}}d.allowselfcommentrating=n.allowSelfCommentRating}return o?e[0]:e},convertFormToJson:function convertFormToJson(e){var t={};e.find(":input").each(function(){var e=n(this).prop("type"),o=n(this).attr("name");if(("checkbox"===e||"radio"===e)&&this.checked||"button"!==e&&"submit"!==e){t[o]=n(this).val()}});return t},createComment:function createComment(e){var t=this;e=t.getParamsBeforeCallApi(e);var n=o.call([{methodname:a.ACTION_CREATE,args:e}]);return n[0]},appendComment:function appendComment(e,t,o){var i=this;M.util.js_pending(a.ACTION_APPEND_COMMENT);E.render(a.TEMPLATE_COMMENT,e).done(function(E){var d=n(E);t.append(d);if(!i.lastCurrentCount){n(a.SELECTOR.COMMENT_FILTER).removeClass(a.SELECTOR.COMMENT_FILTER_HIDE);i.updateCommentCount(1,1);i.btnExpandAll.prop("disabled",!0);i.btnExpandAll.hide();i.btnCollapseAll.prop("disabled",!1);i.btnCollapseAll.show();i.expand=!0;i.isNoComment=!1}else{i.updateCommentCount(i.lastCurrentCount+1,i.lastTotal+1)}if(o){i.bindReplyEvent(e,d.parent())}else{i.bindCommentEvent(e)}i.loadingIcon.hide();i.changeWorkingState(!1);M.util.js_complete(a.ACTION_APPEND_COMMENT)})},loadFragmentForm:function loadFragmentForm(e,t){var n=this;M.util.js_pending(a.ACTION_LOAD_FRAGMENT_FORM);var o=n.getParamsBeforeCallApi({replyto:t.id,cancelbutton:!0,forcecommenting:n.forceCommenting}),i=n.formSelector.find(a.SELECTOR.ATTO_EDITOR_WRAP);if(0!==i.length&&i.hasClass("error")){i.removeClass("error");i.find("#id_error_message_5btext_5d").remove()}d.loadFragment("mod_studentquiz",a.FRAGMENT_FORM_CALLBACK,n.contextId,o).done(function(o,i){E.replaceNodeContents(e,o,i);var d="#id_editor_question_"+n.questionId+"_"+t.id+"editable";e.find(d).focus();n.bindFragmentFormEvent(e,t);M.util.js_complete(a.ACTION_LOAD_FRAGMENT_FORM)})},bindFragmentFormEvent:function bindFragmentFormEvent(t,n){var o=this,i=t.find(a.SELECTOR.COMMENT_AREA_FORM);t.find(a.SELECTOR.SUBMIT_BUTTON).click(function(E){E.preventDefault();o.changeWorkingState(!0);var e=o.convertFormToJson(i);if(0===e["message[text]"].length){return!0}var d=o.loadingIcon.clone().show();d.appendTo(t);i.hide();o.createReplyComment(t,n,i,e);return!0});o.fragmentFormCancelEvent(i,!1);o.bindEditorEvent(t)},createReplyComment:function createReplyComment(e,t,o,i){var E=this,d={replyto:t.id,message:{text:i["message[text]"],format:i["message[format]"]}};M.util.js_pending(a.ACTION_CREATE_REPLY);E.createComment(d).then(function(o){n(a.SELECTOR.COMMENT_ERROR).addClass("hide");var i=E.elementSelector.find(a.SELECTOR.COMMENT_ID+t.id),d=i.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER);t.numberofreply++;var r=parseInt(i.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text())+1;i.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text(r);i.find(a.SELECTOR.COMMENT_COUNT_TEXT).html(1===r?E.string.reply:E.string.replies);e.empty();var l=E.convertForTemplate(o,!0);E.appendComment(l,d,!0);M.util.js_complete(a.ACTION_CREATE_REPLY);return!0}).fail(function(t){E.handleFailWhenCreateComment(t,d);M.util.js_complete(a.ACTION_CREATE_REPLY)})},handleFailWhenCreateComment:function handleFailWhenCreateComment(t,e){var n=this;n.showError(t.message);var o=a.SELECTOR.COMMENT_ID+e.replyto+" "+a.SELECTOR.FRAGMENT_FORM;n.elementSelector.find(o).empty()},getFragmentFormReplyEvent:function getFragmentFormReplyEvent(e){var t=this,n=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),o=n.find(a.SELECTOR.FRAGMENT_FORM).first(),i=n.find(a.SELECTOR.POST_FOOTER).first(),E=t.loadingIcon.clone().show();o.append(E);o.removeClass("edit");o.addClass("reply");t.loadFragmentForm(o,e);t.changeWorkingState(!0,i)},fragmentFormCancelEvent:function fragmentFormCancelEvent(t,n){var o=this;t.find("#id_cancel").click(function(i){i.preventDefault();var e=t.closest(a.SELECTOR.COMMENT_ITEM);if(n){o.lastFocusElement=e.find(a.SELECTOR.BTN_EDIT)}else{o.lastFocusElement=e.find(a.SELECTOR.BTN_REPLY)}o.changeWorkingState(!1);t.parent().empty()})},bindDeleteEvent:function bindDeleteEvent(e){var t=this;t.deleteTarget=e;if(t.deleteDialog){t.deleteDialog.show()}else{t.changeWorkingState(!0);i.create({type:i.types.DEFAULT,title:t.string.deletecomment,body:t.string.confirmdeletecomment,footer:"<button class=\"btn btn-primary\" type=\"button\" data-action=\"yes\" title=\""+t.string.deletecomment+"\">"+t.string.deletetext+"</button><button class=\"btn btn-secondary\" type=\"button\" data-action=\"no\" title=\""+t.string.cancel+"\">"+t.string.cancel+"</button>"}).done(function(o){t.deleteDialog=o;o.getFooter().find("button[data-action=\"no\"]").click(function(t){t.preventDefault();o.hide()});o.getFooter().find("button[data-action=\"yes\"]").click(function(i){i.preventDefault();M.util.js_pending(a.ACTION_DELETE);t.changeWorkingState(!0);t.deleteComment(t.deleteTarget.id).then(function(e){if(!e.success){t.showError(e.message);return!0}var i=t.convertForTemplate(e.data,t.deleteTarget.expanded),d=n(a.SELECTOR.COMMENT_ID+i.id),r=1;t.updateCommentCount(t.lastCurrentCount-r,t.lastTotal-r);if(!i.root){i.expanded=!0}E.render(a.TEMPLATE_COMMENT,i).done(function(o){var E=n(o);if(!i.root){var r=d.parent(),l=r.closest(a.SELECTOR.COMMENT_ITEM).find(a.SELECTOR.TOTAL_REPLY),T=l.find(a.SELECTOR.COMMENT_COUNT_NUMBER),m=parseInt(T.text())-1;l.find(a.SELECTOR.COMMENT_COUNT_NUMBER).text(m);l.find(a.SELECTOR.COMMENT_COUNT_TEXT).html(1===m?t.string.reply:t.string.replies)}var s=d.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).clone(!0);d.replaceWith(E);E.find(a.SELECTOR.COMMENT_REPLIES_CONTAINER).replaceWith(s);if(t.deleteTarget.root){t.bindCommentEvent(e.data)}else{t.bindReplyEvent(e.data,E.parent())}t.changeWorkingState(!1);M.util.js_complete(a.ACTION_DELETE)});o.hide();return!0}).fail(function(e){t.showError(e.message);return!1})});o.getRoot().on(r.hidden,function(){var e=n(a.SELECTOR.COMMENT_ID+t.deleteTarget.id);if(t.deleteTarget.root){e.find(a.SELECTOR.BTN_DELETE).first().focus()}else{e.find(a.SELECTOR.BTN_DELETE_REPLY).first().focus()}});o.getRoot().on(r.shown,function(){t.changeWorkingState(!1)});o.show();t.changeWorkingState(!1)})}},deleteComment:function deleteComment(e){var t=this,n=t.getParamsBeforeCallApi({commentid:e}),i=o.call([{methodname:a.ACTION_DELETE,args:n}]);return i[0]},bindEditorEvent:function bindEditorEvent(e){var t=this;M.util.js_pending("init_editor");t.triggerAttoNoContent(e);e.find(a.SELECTOR.ATTO.TOOLBAR).fadeIn();var n=e.find(a.SELECTOR.TEXTAREA),o=n.attr("id")+"editable",i=document.getElementById(o),E=new MutationObserver(function(n){n.forEach(function(n){if("attributes"===n.type&&("style"===n.attributeName||"hidden"===n.attributeName)){t.checkEditorContent(e)}})});E.observe(i,{attributes:!0,childList:!0,subtree:!0});n.change(function(){t.checkEditorContent(e)});M.util.js_complete("init_editor");var d=setInterval(function(){e.find("textarea[id^=\"id_message\"]").trigger("change")},350);setTimeout(function(){clearInterval(d)},5e3)},checkEmptyElement:function checkEmptyElement(e){return 0===e.children().length},setHasComment:function setHasComment(e){var t=this,o=n(a.SELECTOR.CONTAINER),i=a.HAS_COMMENT_CLASS;if(!t.forceCommenting){t.hasComment=!0;o.addClass(i)}else{t.hasComment=e;if(t.hasComment){o.addClass(i)}else{o.removeClass(i)}}},parseQueryString:function parseQueryString(e){for(var t=e.split("&"),n={},o=0;o<t.length;o++){var E=t[o].split("="),d=decodeURIComponent(E[0]),r=decodeURIComponent(E[1]);if("undefined"==typeof n[d]){n[d]=decodeURIComponent(r)}else if("string"==typeof n[d]){n[d]=[n[d],decodeURIComponent(r)]}else{n[d].push(decodeURIComponent(r))}}return n},scrollToElement:function scrollToElement(e,t){if(!e.length){return}if("undefined"==typeof t){t=1e3}var o=e.offset().top;n("html,body").animate({scrollTop:o},t)},buildRefererReportLink:function buildRefererReportLink(e,t){var n=this,o=decodeURIComponent(n.referer);e+="&referer="+encodeURIComponent(o+"&highlight="+t);return e},triggerAttoHasContent:function triggerAttoHasContent(e){var t=e.find(a.SELECTOR.ATTO.CONTENT_WRAP),n=e.find(a.SELECTOR.SUBMIT_BUTTON);n.removeClass("disabled");n.prop("disabled",!1);t.attr("data-placeholder","");t.addClass(a.ATTO_CONTENT_TYPE.HAS_CONTENT);t.removeClass(a.ATTO_CONTENT_TYPE.NO_CONTENT)},triggerAttoNoContent:function triggerAttoNoContent(e){var t=e.attr("data-textarea-placeholder"),n=e.find(a.SELECTOR.ATTO.CONTENT_WRAP),o=e.find(a.SELECTOR.SUBMIT_BUTTON);o.addClass("disabled");o.prop("disabled",!0);n.attr("data-placeholder",t);n.addClass(a.ATTO_CONTENT_TYPE.NO_CONTENT);n.removeClass(a.ATTO_CONTENT_TYPE.HAS_CONTENT)},setSort:function setSort(e){var t=this;if(-1!==n.inArray(e,t.sortable)){t.sortFeature=e}},getFragmentEditFormEvent:function getFragmentEditFormEvent(e){var t=this,n=t.elementSelector.find(a.SELECTOR.COMMENT_ID+e.id),o=n.find(a.SELECTOR.FRAGMENT_FORM).first(),i=n.find(a.SELECTOR.POST_FOOTER).first(),E=t.loadingIcon.clone().show();o.append(E);o.removeClass("reply");o.addClass("edit");t.loadFragmentEditForm(o,e);t.changeWorkingState(!0,i)},loadFragmentEditForm:function loadFragmentEditForm(e,t){var n=this;M.util.js_pending(a.ACTION_LOAD_FRAGMENT_EDIT_FORM);var o=n.getParamsBeforeCallApi({cancelbutton:!0,forcecommenting:n.forceCommenting,commentid:t.id}),i=n.formSelector.find(a.SELECTOR.ATTO_EDITOR_WRAP);if(0!==i.length&&i.hasClass("error")){i.removeClass("error");i.find("#id_error_message_5btext_5d").remove()}d.loadFragment("mod_studentquiz",a.FRAGMENT_EDIT_FORM_CALLBACK,n.contextId,o).done(function(o,i){E.replaceNodeContents(e,o,i);var d="#id_editor_question_"+n.questionId+"_"+t.id+"editable";e.find(d).focus();n.bindFragmentEditFormEvent(e,t);M.util.js_complete(a.ACTION_LOAD_FRAGMENT_EDIT_FORM)})},bindFragmentEditFormEvent:function bindFragmentEditFormEvent(t,n){var o=this,i=t.find(a.SELECTOR.COMMENT_AREA_FORM);t.find(a.SELECTOR.SUBMIT_BUTTON).click(function(E){E.preventDefault();o.changeWorkingState(!0);var e=o.convertFormToJson(i);if(0===e["message[text]"].length){return!0}var d=o.loadingIcon.clone().show();d.appendTo(t);i.hide();o.editCommentEvent(t,n,i,e);return!0});o.fragmentFormCancelEvent(i,!0);o.bindEditorEvent(t)},editCommentEvent:function editCommentEvent(e,t,o,i){var d=this;M.util.js_pending(a.ACTION_EDIT);var r={commentid:t.id,message:{text:i["message[text]"],format:i["message[format]"]}};d.editComment(r).then(function(o){n(a.SELECTOR.COMMENT_ERROR).addClass("hide");var i=d.elementSelector.find(a.SELECTOR.COMMENT_ID+t.id);d.lastFocusElement=i.find(a.SELECTOR.BTN_EDIT);if(0===d.lastFocusElement.length){d.lastFocusElement=i.find(a.SELECTOR.BTN_EDIT_REPLY)}t.shortcontent=o.shortcontent;o.expanded=t.expanded;E.render(a.TEMPLATE_COMMENT,o).done(function(e){var t=n(e),i=a.SELECTOR.COMMENT_ID+o.id+" "+a.SELECTOR.COMMENT_TEXT_CONTAINER;n(i).first().html(t.find(a.SELECTOR.COMMENT_TEXT_CONTAINER).html())});e.empty();d.changeWorkingState(!1);M.util.js_complete(a.ACTION_EDIT);return!0}).fail(function(t){d.handleFailWhenCreateComment(t,r);M.util.js_complete(a.ACTION_EDIT)})},editComment:function editComment(e){var t=this;e=t.getParamsBeforeCallApi(e);var n=o.call([{methodname:a.ACTION_EDIT,args:e}]);return n[0]},checkEditorContent:function checkEditorContent(e){var t="text_change_"+Date.now();M.util.js_pending(t);var o=e.find(a.SELECTOR.TEXTAREA),i=o.attr("id")+"editable",E=n("#"+i);if(-1<a.EMPTY_CONTENT.indexOf(E.html())||1>E.text().trim().length){this.triggerAttoNoContent(e)}else{this.triggerAttoHasContent(e)}M.util.js_complete(t)}}},generate:function generate(e){a.get().init(e)}};return a});
//# sourceMappingURL=comment_area.min.js.map
